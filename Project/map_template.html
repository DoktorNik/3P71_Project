<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Routes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
    />
    <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
    ></script>

    <style>
        html, body { height: 100%; margin: 0; }
        #map { height: 100%; width: 100%; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    const map = L.map('map');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Inserted by Java:
    // routes = [
    //   { name, color, conditionStr, points:[{lat, lon, idx}, ...] },
    //   ...
    // ]
    const routes = __ROUTES_JSON__;

    const polylines = [];
    const markers = [];

    function addRoute(route) {
        if (!route || !route.points || route.points.length < 2) return;

        const coords = route.points.map(p => [p.lat, p.lon]);

        const poly = L.polyline(coords, {
            color: route.color,
            weight: 6,
            opacity: 0.9
        }).addTo(map);
        polylines.push(poly);

        // Route label at midpoint
        const midIdx = Math.floor(route.points.length / 2);
        const mid = route.points[midIdx];
        const routeLabel = `${route.name} â€” Condition: ${route.conditionStr}`;

        L.marker([mid.lat, mid.lon], { opacity: 0.0 })
            .addTo(map)
            .bindTooltip(routeLabel, { permanent: true, direction: 'top', offset: [0, -8] })
            .openTooltip();

        // Label each point with its index in the route ArrayList<Point>
        for (const p of route.points) {
            const m = L.circleMarker([p.lat, p.lon], {
                radius: 4,
                weight: 1,
                opacity: 0.9,
                fillOpacity: 0.8
            }).addTo(map);

            m.bindTooltip(String(p.idx), { permanent: true, direction: 'right', offset: [6, 0] });
            markers.push(m);
        }
    }

    for (const r of routes) addRoute(r);

    if (polylines.length > 0) {
        const group = L.featureGroup([...polylines, ...markers]);
        map.fitBounds(group.getBounds().pad(0.15));
    } else {
        map.setView([43.0, -79.0], 12);
    }
</script>
</body>
</html>
